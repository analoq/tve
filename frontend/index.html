<!doctype html>
<html>
<head>
<title>Terrestrial Vegetation Evaluator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
<script src="https://github.com/nagix/chartjs-plugin-streaming/releases/download/v1.7.1/chartjs-plugin-streaming.min.js"></script>
<script>
var eventSource = new EventSource("http://localhost:8000/");

var recentConfig = {
  type: 'line',
  data: {
    datasets: [{
	label: 'moisture',
      	cubicInterpolationMode: 'monotone',
	data: []
    }]
  },
  options: {
    scales: {
      xAxes: [{
        type: 'realtime',
	realtime: {
	  delay: 2000,
	  duration: 60 * 1000,
        }
      }]
    }
  }
};

var archiveConfig = {
  type: 'line',
  data: {
    datasets: [{
	label: 'moisture',
      	cubicInterpolationMode: 'monotone',
	data: []
    }]
  },
  options: {
    scales: {
      xAxes: [{
        type: 'realtime',
	realtime: {
	  duration: 24*60*60*1000,
        }
      }]
    }
  }
};

eventSource.onmessage = function(e)
{
    var obj = JSON.parse(e.data);

    if ( obj.dest == 'archive' )
    {
	var config = archiveConfig;
	var chart = window.archiveChart;
    }
    else
    {
	var config = recentConfig;
	var chart = window.recentChart;
    }

    if ( obj.type == 'preload' )
	config.data.datasets[0].data = [];

    for(i = 0; i < obj.items.length; i ++)
    {
    	config.data.datasets[0].data.push({
		x: new Date(obj.items[i].dt),
		y: obj.items[i].value
	    });
    }

    chart.update({
	   preservation: true
    });
};
</script>
</head>
<body>
  <h1>Terrestrial Vegetation Evaluator</h1>

  Last 60 seconds:
  <canvas id="recentChart" width="400" height="100"></canvas>
  Last 24 hours:
  <canvas id="archiveChart" width="400" height="100"></canvas>

  <script>
  var recentContext = document.getElementById("recentChart").getContext("2d");
  var recentChart = new Chart(recentContext, recentConfig);
  var archiveContext = document.getElementById("archiveChart").getContext("2d");
  var archiveChart = new Chart(archiveContext, archiveConfig);
  </script>
</body>
</html>
